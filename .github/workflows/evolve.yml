name: Evolve AI (safe PR flow)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 22 * * *'  # run nightly or adjust

permissions:
  contents: write
  pull-requests: write

jobs:
  evolve:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Run Evolver (generate files inside ai_core/)
        run: |
          python3 self_evolver.py

      - name: Show ai_core changes
        run: git status --porcelain && git --no-pager diff --name-only || true

      - name: Create branch with timestamp
        id: branch
        run: |
          BRANCH="ai-evolve-$(date -u +%Y%m%d%H%M%S)-$GITHUB_RUN_NUMBER"
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

      - name: Commit new files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b ${{ steps.branch.outputs.branch }}
          git add ai_core || true
          git commit -m "chore(ai): propose AI evolution changes [skip ci]" || echo "No changes to commit"

      - name: Push branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git push --set-upstream origin ${{ steps.branch.outputs.branch }}

      - name: Create PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BODY="This PR was auto-generated by the AI Evolver. It modifies files under ai_core/ and includes unit tests. Please review before merging."
          TITLE="chore(ai): propose evolution - ${{ steps.branch.outputs.branch }}"
          API="https://api.github.com/repos/${{ github.repository }}/pulls"
          PAYLOAD=$(jq -n --arg t "$TITLE" --arg b "$BODY" --arg head "${{ steps.branch.outputs.branch }}" --arg base "${{ github.ref_name }}" '{title:$t, body:$b, head:$head, base:$base}')
          echo "$PAYLOAD" > /tmp/payload.json
          curl -s -X POST -H "Authorization: token $GITHUB_TOKEN" -H "Accept: application/vnd.github.v3+json" "$API" --data @/tmp/payload.json | jq '.html_url'
