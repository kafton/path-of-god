name: Evolve AI v2 (PR flow)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 22 * * *'

permissions:
  contents: write
  pull-requests: write

jobs:
  evolve:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install test deps
        run: |
          python -m pip install --upgrade pip
          pip install pytest

      - name: Run Evolver (generate candidates & run tests)
        run: |
          python3 self_evolver_v2.py

      - name: Show changes
        run: git status --porcelain && git --no-pager diff --name-only || true

      - name: Create branch for PR
        id: branch
        run: |
          BR="ai-evolve-$(date -u +%Y%m%d%H%M%S)-${GITHUB_RUN_NUMBER}"
          echo "branch=${BR}" >> $GITHUB_OUTPUT

      - name: Commit ai_core
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b ${{ steps.branch.outputs.branch }}
          git add ai_core || true
          git commit -m "chore(ai): propose evolution changes [skip ci]" || echo "No changes to commit"

      - name: Push branch
        run: git push --set-upstream origin ${{ steps.branch.outputs.branch }}

      - name: Open PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BODY="Auto-generated PR by AI Evolver v2. Please review candidate skills under ai_core/."
          TITLE="chore(ai): propose evolution - ${{ steps.branch.outputs.branch }}"
          API="https://api.github.com/repos/${{ github.repository }}/pulls"
          PAYLOAD=$(jq -n --arg t "$TITLE" --arg b "$BODY" --arg head "${{ steps.branch.outputs.branch }}" --arg base "${{ github.ref_name }}" '{title:$t, body:$b, head:$head, base:$base}')
          curl -s -X POST -H "Authorization: token $GITHUB_TOKEN" -H "Accept: application/vnd.github.v3+json" "$API" --data "$PAYLOAD" | jq '.html_url'
